- name: Configure Flannel on worker nodes
  hosts: all
  remote_user: ubuntu
  become: true
  vars:
    flannel_network: "10.244.0.0/16"
    flannel_mtu: 1450
    flannel_ipmasq: true

    # Per-node subnet mapping
    flannel_subnets:
      192.168.0.155: "10.244.3.1/24"
      192.168.0.156: "10.244.2.1/24"
      192.168.0.158: "10.244.1.1/24"
      192.168.0.159: "10.244.4.1/24"

  tasks:
    - name: Create /run/flannel directory
      file:
        path: /run/flannel
        state: directory
        mode: '0755'

    - name: Set flannel_subnet for this host
      set_fact:
        flannel_subnet: "{{ flannel_subnets[ansible_host] }}"

    - name: Create Flannel subnet.env file
      copy:
        dest: /run/flannel/subnet.env
        content: |
          FLANNEL_NETWORK={{ flannel_network }}
          FLANNEL_SUBNET={{ flannel_subnet }}
          FLANNEL_MTU={{ flannel_mtu }}
          FLANNEL_IPMASQ={{ flannel_ipmasq }}
        owner: root
        group: root
        mode: '0644'

    - name: Restart kubelet
      systemd:
        name: kubelet
        state: restarted